{% extends "base.html" %}

{% block content %}
<div class="container mt-5">
    <h2 class="mb-4">Pasientprofil: {{ patient.first_name }} {{ patient.last_name }}</h2>

    <div class="card">
        <div class="card-body">
            <h3 class="card-title">Endre Pasientinformasjon</h3>
            <form method="POST" class="mt-3">
                {{ edit_form.hidden_tag() }}
                <div class="row">
                    <div class="col-md-6 mb-3">
                        {{ edit_form.first_name.label(class="form-label") }}
                        {{ edit_form.first_name(class="form-control") }}
                        {% if edit_form.first_name.errors %}
                            {% for error in edit_form.first_name.errors %}
                                <div class="alert alert-danger">{{ error }}</div>
                            {% endfor %}
                        {% endif %}
                    </div>
                    <div class="col-md-6 mb-3">
                        {{ edit_form.last_name.label(class="form-label") }}
                        {{ edit_form.last_name(class="form-control") }}
                        {% if edit_form.last_name.errors %}
                            {% for error in edit_form.last_name.errors %}
                                <div class="alert alert-danger">{{ error }}</div>
                            {% endfor %}
                        {% endif %}
                    </div>
                </div>

                                <!-- Personnummer -->
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        {{ edit_form.personal_number.label(class="form-label") }}
                                        {{ edit_form.personal_number(class="form-control") }}
                                        {% if edit_form.personal_number.errors %}
                                            {% for error in edit_form.personal_number.errors %}
                                                <div class="alert alert-danger">{{ error }}</div>
                                            {% endfor %}
                                        {% endif %}
                                    </div>
                
                                    <!-- Fødselsdato -->
                                    <div class="col-md-6 mb-3">
                                        {{ edit_form.birth_date.label(class="form-label") }}
                                        {{ edit_form.birth_date(class="form-control") }}
                                        {% if edit_form.birth_date.errors %}
                                            {% for error in edit_form.birth_date.errors %}
                                                <div class="alert alert-danger">{{ error }}</div>
                                            {% endfor %}
                                        {% endif %}
                                    </div>
                                </div>
                
                                <!-- Kjønn -->
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        {{ edit_form.gender.label(class="form-label") }}
                                        {{ edit_form.gender(class="form-control") }}
                                        {% if edit_form.gender.errors %}
                                            {% for error in edit_form.gender.errors %}
                                                <div class="alert alert-danger">{{ error }}</div>
                                            {% endfor %}
                                        {% endif %}
                                    </div>
                
                                    <!-- Adresse -->
                                    <div class="col-md-6 mb-3">
                                        {{ edit_form.address.label(class="form-label") }}
                                        {{ edit_form.address(class="form-control") }}
                                        {% if edit_form.address.errors %}
                                            {% for error in edit_form.address.errors %}
                                                <div class="alert alert-danger">{{ error }}</div>
                                            {% endfor %}
                                        {% endif %}
                                    </div>
                                </div>
                
                                <!-- Postnummer og Kommune på samme rad -->
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        {{ edit_form.postal_code.label(class="form-label") }}
                                        {{ edit_form.postal_code(class="form-control") }}
                                        {% if edit_form.postal_code.errors %}
                                            {% for error in edit_form.postal_code.errors %}
                                                <div class="alert alert-danger">{{ error }}</div>
                                            {% endfor %}
                                        {% endif %}
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        {{ edit_form.municipality.label(class="form-label") }}
                                        {{ edit_form.municipality(class="form-control") }}
                                        {% if edit_form.municipality.errors %}
                                            {% for error in edit_form.municipality.errors %}
                                                <div class="alert alert-danger">{{ error }}</div>
                                            {% endfor %}
                                        {% endif %}
                                    </div>
                                </div>
                
                                <button type="submit" class="btn btn-primary">Oppdater Pasient</button>
                            </form>
                        </div>
                    </div>
                
                
                <button type="submit" class="btn btn-primary mt-2">Oppdater Pasient</button>
            </form>
        </div>

    <!-- Journalnotater Liste -->
<h3 class="mt-5">Journalnotater</h3>
{% if journal_entries %}
    <ul class="list-group">
        {% for entry in journal_entries|reverse %}
            <li class="list-group-item">
                {{ entry.entry_date.strftime('%Y-%m-%d') }}:
                <div id="note-{{ entry.id }}">{{ entry.notes }}</div>
                <button type="button" class="btn btn-primary" onclick="editNote('{{ entry.id }}')">Rediger</button>
            </li>
        {% endfor %}
    </ul>
{% else %}
    <p>Ingen journalnotater funnet.</p>
{% endif %}

<!-- Rediger Notat Modal -->
<div class="modal fade" id="editNoteModal" tabindex="-1" aria-labelledby="editNoteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editNoteModalLabel">Rediger Notat</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <textarea id="editNoteTextarea"></textarea>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Lukk</button>
                <button type="button" class="btn btn-primary" onclick="saveNote()">Lagre</button>
            </div>
        </div>
    </div>
</div>

<script>
    // Funksjon for å åpne redigeringsmodalen og initialisere CKEditor
    function editNote(noteId) {
        var noteContent = document.getElementById('note-' + noteId).innerHTML;
        CKEDITOR.replace('editNoteTextarea');
        CKEDITOR.instances.editNoteTextarea.setData(noteContent);
        $('#editNoteModal').modal('show');
    }

    // Eksempel på funksjon for å lagre notatet
    function saveNote() {
        var updatedContent = CKEDITOR.instances.editNoteTextarea.getData();
        // Logikk for å sende det oppdaterte innholdet til serveren og oppdatere databasen
        console.log(updatedContent); // Bytt dette ut med din lagringslogikk
        $('#editNoteModal').modal('hide');
        // Oppdater siden eller den spesifikke delen for å vise det oppdaterte notatet
    }
</script>

</div>

{% endblock %}
